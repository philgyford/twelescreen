function shuffle(a){for(var b,c,d=a.length;d--;)c=Math.random()*d|0,b=a[d],a[d]=a[c],a[c]=b;return a}jQuery.fn.exists=function(){return jQuery(this).length>0},function(a){a.fn.queueFn=function(b){var c,d,e=Array.prototype.slice.call(arguments,1);return"boolean"==typeof b&&(b&&(d=this,c=this.length),b=e.shift()),b=a.isFunction(b)?b:a.fn[b],this.queue(function(){!--c&&b.apply(d||this,e),a.dequeue(this)})}}(jQuery),jQuery.expr.filters.offscreen=function(a){return a.offsetLeft+a.offsetWidth<0||a.offsetTop+a.offsetHeight<0||a.offsetLeft>window.innerWidth||a.offsetTop>window.innerHeight},function(a){a.fn.fitText=function(b,c){var d=b||1,e=a.extend({minFontSize:Number.NEGATIVE_INFINITY,maxFontSize:Number.POSITIVE_INFINITY},c);return this.each(function(){var b=a(this),c=function(){b.css("font-size",Math.max(Math.min(b.width()/(10*d),parseFloat(e.maxFontSize)),parseFloat(e.minFontSize)))};c(),a(window).on("resize.fittext orientationchange.fittext",c)})}}(jQuery),function(a){a.fn.fitTextBlock=function(){return this.each(function(){var b=a(this),c=function(){var a=function(b,c){b.css("font-size",c).data("font-size",c),(b.height()>b.parent().height()||b[0].offsetWidth<b[0].scrollWidth)&&a(b,.9*c)};a(b,b.parent().height())};c()})}}(jQuery);var twelescreen={controller:{},models:{}};twelescreen.controller={config:{disconnect_warning:"Connection to server lost",category_key:"",font:null,screen_names:[],greetings:["Hello there"],slogans:[],number_of_tweets:5,time_per_slide:5e3,slide_transition_time:400,greeting_time:5e3,chance_of_slogan:5},page:null,socket:null,tweet_queue:[],tweet_store:[],current_store_index:0,greeting_queue:[],slogan_queue:[],auto_advance:!0,logging:!1,init:function(a,b){$.extend(this.config,b),this.config.screen_names=this.config.screen_names.map(function(a){return a.toLowerCase()});var c,d=this;"screen"==a?(this.log("Displaying screen page"),this.page=twelescreen.models.screen_page({burn_in_text:this.config.burn_in_text}),c=function(){d.log("Initialising page"),d.page.init(),d.prepare_connection();var a=function(){$("#loading").remove(),d.next_tick()};d.listen_for_tweets(a)}):(this.log("Displaying menu page"),this.page=twelescreen.models.menu_page({}),c=function(){d.log("Initialising page"),$("#loading").remove(),d.page.init()}),this.prepare_fonts(c)},prepare_fonts:function(a){var b=$.Deferred(),c=this;this.config.font&&"undefined"!=typeof WebFont?WebFont.load({google:{families:[this.config.font]},active:function(){c.log("Font loaded"),b.resolve()},inactive:function(){console.log("WebFonts failed to load."),b.resolve()},timeout:3e3}):b.resolve(),b.done(a)},prepare_connection:function(){var a=this;a.log("Preparing connection"),a.socket=io.connect(window.location.hostname),a.socket.on("connect",function(){a.page.hide_alert("connection-alert"),a.socket.emit("subscribe",a.config.category_key)}),a.socket.on("disconnect",function(){a.page.show_alert("connection-alert",a.config.disconnect_warning)})},listen_for_tweets:function(a){var b=this;b.log("Listening for tweets"),b.socket.on("messages",function(c){$.each(c.tweets,function(a,d){b.tweet_is_in_this_category(d)&&("cached"==c.type?(b.log("Cached tweet received: "+d.text),b.add_to_tweet_store(d)):(b.log("New tweet received: "+d.text),b.add_to_tweet_queue(d)))}),"cached"==c.type&&a()})},next_tick:function(){this.auto_advance&&this.show_next_item()},show_next_item:function(){if(this.current_slide)if(this.tweet_queue.length>0){this.log("Display: Greeting slide for new Tweet");var a=this;this.page.get_greeting_slide().update_text(this.new_greeting_text()),this.page.get_greeting_slide().transition().done(function(){a.log("Display: Tweet slide for new Tweet"),a.add_to_tweet_store(a.tweet_queue.shift());var b=a.page.get_tweet_slides()[a.current_store_index];b.transition().done(function(){a.next_tick()})})}else if(this.config.slogans.length>0&&100*Math.random()<this.config.chance_of_slogan&&$("#greeting").is(":offscreen")&&$("#slogan").is(":offscreen")){this.log("Display: Slogan slide");var a=this;this.page.get_slogan_slide().update_text(this.new_slogan_text()),this.page.get_slogan_slide().transition().done(function(){a.next_tick()})}else if(this.tweet_store.length>0){this.log("Display: Tweet slide with stored Tweet"),this.page.hide_alert("tweets-alert"),this.current_store_index==this.tweet_store.length-1?this.current_store_index=0:this.current_store_index++;var b=this.page.get_tweet_slides()[this.current_store_index],a=this;b.transition().done(function(){a.next_tick()})}else{this.log("Display: No tweets found!"),this.page.show_alert("tweets-alert","No tweets found");var a=this;setTimeout(function(){a.next_tick()},a.config.time_per_slide)}else{this.log("First Greeting slide");var a=this;this.page.get_greeting_slide().update_text(this.new_greeting_text()),this.page.get_greeting_slide().transition().done(function(){a.next_tick()})}},add_to_tweet_store:function(a){this.page.add_new_tweet_slide({id:"tweet-"+a.id,tweet:a,duration:this.config.time_per_slide,transition_time:this.config.slide_transition_time}),this.tweet_store.push(a),this.tweet_store.length>this.config.number_of_tweets&&(this.tweet_store.shift(),this.page.remove_oldest_tweet_slide()),this.current_store_index=this.tweet_store.length-1},add_to_tweet_queue:function(a){this.tweet_queue.push(a)},tweet_is_in_this_category:function(a){return this.config.screen_names.indexOf(a.user.screen_name.toLowerCase())>-1?!0:!1},new_greeting_text:function(){return 0==this.greeting_queue.length&&(this.greeting_queue=shuffle(this.config.greetings)),this.greeting_queue.shift()},new_slogan_text:function(){return 0==this.slogan_queue.length&&(this.slogan_queue=shuffle(this.config.slogans)),this.slogan_queue.shift()},log:function(a){this.logging&&console.log(a)}},twelescreen.models.base=function(a){var b={};return b.object_vars=[],b.construct=function(){$.each(b.object_vars,function(c,d){b["get_"+d]=function(){return a[d]},b["set_"+d]=function(b){a[d]=b}})},b},twelescreen.models.page=function(a){var b=twelescreen.models.base(a);return b.object_vars=b.object_vars.concat([]),b.construct(),b.base_init=function(){var a=function(a,b){var c,b=b||200;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,Array.prototype.slice.call(e))},b)}};$(window).resize(a(function(){b.resize()}))},b.init=function(){b.base_init()},b.resize=function(){},b.show_alert=function(a,b){$("#"+a).exists()?$("#"+a+" .alert_inner").text(b):$("body").append("<div id="+a+' class="alert"><div class="alert_inner">'+b+"</div></div>"),$("#"+a).fitText(4)},b.hide_alert=function(a){$("#"+a).remove()},b},twelescreen.models.menu_page=function(a){var b=twelescreen.models.page(a);return b.object_vars=b.object_vars.concat([]),b.construct(),b.init=function(){b.base_init(),b.resize()},b.resize=function(){$(".menu").exists()&&($(".menu").height($(window).height()),$(".menu_body").height()<$(".menu_body_inner").outerHeight(!0)&&$(".menu").height("auto"))},b},twelescreen.models.screen_page=function(a){var b=twelescreen.models.page(a);return b.object_vars=b.object_vars.concat(["burn_in_text","burn_slide","greeting_slide","slogan_slide","tweet_slides"]),b.construct(),b.init=function(){b.base_init(),b.set_tweet_slides([]),b.get_burn_in_text()&&(b.set_burn_slide(twelescreen.models.burn_title_slide({id:"burn",text:b.get_burn_in_text()})),b.get_burn_slide().create_element()),b.set_greeting_slide(twelescreen.models.greeting_title_slide({id:"greeting",text:"",duration:twelescreen.controller.config.greeting_time})),b.get_greeting_slide().create_element(),twelescreen.controller.config.slogans.length>0&&(b.set_slogan_slide(twelescreen.models.slogan_title_slide({id:"slogan",text:"",duration:twelescreen.controller.config.time_per_slide})),b.get_slogan_slide().create_element())},b.resize=function(){b.get_burn_slide()&&b.get_burn_slide().resize(),b.get_greeting_slide()&&b.get_greeting_slide().resize(),b.get_slogan_slide()&&b.get_slogan_slide().resize(),$.each(b.get_tweet_slides(),function(a,b){b.resize()})},b.add_new_tweet_slide=function(a){var c=twelescreen.models.tweet_slide(a);c.create_element();var d=b.get_tweet_slides();d.push(c),b.set_tweet_slides(d)},b.remove_oldest_tweet_slide=function(){var a=b.get_tweet_slides(),c=a.shift();c.remove(),b.set_tweet_slides(a)},b},twelescreen.models.slide=function(a){var b=twelescreen.models.base(a);return b.object_vars=b.object_vars.concat(["id","type","duration"]),b.construct(),b.set_type("default"),b.create_element=function(){$("body").append($("<div/>").attr("id",b.get_id()).addClass("slide")),b.resize()},b.transition=function(){var a=$.Deferred();$("#"+b.get_id()).show();var c=twelescreen.controller.current_slide;return c&&$("#"+c.get_id()).hide(),b.play().done(function(){twelescreen.controller.current_slide=b,a.resolve()}),a.promise()},b.play=function(){var a=$.Deferred(),c=b.get_duration();return"undefined"==typeof c&&(c=5e3),setTimeout(function(){a.resolve()},c),a.promise()},b.resize=function(){$("#"+b.get_id()).width($(window).width()).height($(window).height()),b.resize_extra()},b.resize_extra=function(){},b.remove=function(){$("#"+b.get_id()).remove()},b},twelescreen.models.title_slide=function(a){var b=twelescreen.models.slide(a);return b.object_vars=b.object_vars.concat(["text","fit_text_size"]),b.construct(),b.set_type("title"),b.create_element=function(){$("body").append($("<div/>").attr("id",b.get_id()).addClass("slide slide-title vbox hbox").append($("<div/>").addClass("slide_inner"))),b.get_text()&&b.update_elements_text(),b.resize()},b.update_text=function(a){b.set_text(a),b.update_elements_text(),$("html").hasClass("flexbox")||b.resize_extra()},b.update_elements_text=function(){$("#"+b.get_id()+" .slide_inner").html(b.get_text())},b.transition=function(){var a=$.Deferred();$("#"+b.get_id()).addClass("is-slide-on");var c=twelescreen.controller.current_slide;return c&&("tweet"==c.get_type()?$("#"+c.get_id()).removeClass("is-slide-on").css("z-index",100):$("#"+c.get_id()).removeClass("is-slide-on")),b.play().done(function(){twelescreen.controller.current_slide=b,a.resolve()}),a.promise()},b.resize_extra=function(){var a=$("#"+b.get_id()),c=b.get_fit_text_size()||1;if(a.fitText(c),$("html").hasClass("flexbox")){var d=Math.round(a.height()/12);a.css("paddingBottom",d).height(a.height()-d)}else $(".slide_inner",a).css("marginTop",(a.outerHeight()-$(".slide_inner",a).height())/2.2)},b},twelescreen.models.greeting_title_slide=function(a){var b=twelescreen.models.title_slide(a);return b.object_vars=b.object_vars.concat([]),b.construct(),b.set_type("greeting_title"),b.play=function(){var a=$.Deferred(),c=b.get_duration()/5;return $("#"+b.get_id()).delay(c).queueFn(function(){$(this).addClass("is-inverted")}).delay(c).queueFn(function(){$(this).removeClass("is-inverted")}).delay(c).queueFn(function(){$(this).addClass("is-inverted")}).delay(c).queueFn(function(){$(this).removeClass("is-inverted")}).delay(c).queueFn(function(){a.resolve()}),a.promise()},b},twelescreen.models.burn_title_slide=function(a){var b=twelescreen.models.title_slide(a);return b.object_vars=b.object_vars.concat([]),b.construct(),b.set_type("burn_title"),b.transtion=function(){},b.play=function(){},b},twelescreen.models.slogan_title_slide=function(a){var b=twelescreen.models.title_slide(a);return b.object_vars=b.object_vars.concat([]),b.construct(),b.set_type("slogan_title"),b},twelescreen.models.tweet_slide=function(a){var b=twelescreen.models.slide(a);return b.object_vars=b.object_vars.concat(["tweet","transition_time"]),b.construct(),b.set_type("tweet"),b.create_element=function(){var a=b.get_tweet(),c=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,d=a.text.replace(c,"<a href='$1'>$1</a>");$("body").append($("<div/>").attr("id",b.get_id()).addClass("slide slide-tweet").append($("<div/>").addClass("tweet_account").html('<img src="'+a.user.profile_image_url+'" alt="" class="tweet_account_avatar" /><div class="tweet_account_name"><a href="https://twitter.com/'+a.user.screen_name+'">'+a.user.name+"</a></div>")).append($("<div/>").addClass("tweet_message").html('<div class="tweet_message_panel tweet_message_panel-text vbox"><div class="tweet_message_panel_inner">'+d+"</div></div>")).addClass("slide")),"image"in a&&$(".tweet_message",$("#"+b.get_id())).append($("<div/>").addClass("tweet_message_panel tweet_message_panel-image vbox hbox").append($("<div/>").addClass("tweet_message_panel_inner").append($("<img/>").attr("src",a.image.url).data({width:a.image.width,height:a.image.height,orientation:a.image.width>=a.image.height?"landscape":"portrait"}))).css("z-index",100)),b.resize()},b.transition=function(){var a=$.Deferred();$to=$("#"+b.get_id()),$(".tweet_message_panel-text",$to).css("opacity",1);var c=twelescreen.controller.current_slide;return c?($from=$("#"+c.get_id()),["greeting_title","slogan_title"].indexOf(c.get_type())>-1?($to.addClass("is-slide-on").css({zIndex:200}),$from.removeClass("is-slide-on")):($to.addClass("is-slide-on"),$from.animate({opacity:0},b.get_transition_time(),function(){$from.removeClass("is-slide-on").css({zIndex:100,opacity:1}),$to.css({zIndex:200})}))):$to.addClass("is-slide-on").css({zIndex:200}),b.play().done(function(){twelescreen.controller.current_slide=b,setTimeout(function(){$(".tweet_message_panel-image",$to).exists()?$(".tweet_message_panel-text",$to).animate({opacity:0},b.get_transition_time(),function(){setTimeout(function(){a.resolve()},b.get_duration())}):a.resolve()},b.get_duration())}),a.promise()},b.resize_extra=function(){$slide=$("#"+b.get_id()),$(".tweet_account",$slide).fitText(1.5);var a=Math.floor($(".tweet_account",$slide).height()),c=Math.floor(a/8),d=Math.floor(a/3),e=$(window).height()-a-c-d;if($(".tweet_message",$slide).css({"margin-top":a,"padding-top":c,"padding-bottom":d}).height(e),$(".tweet_message_panel").height(e),$(".tweet_message_panel-image",$slide).exists()){var f,g,h=$(".tweet_message_panel-image img",$slide),i=$(".tweet_message_panel-image",$slide).width(),j=$(".tweet_message_panel-image",$slide).height()-d;"landscape"==h.data("orientation")?(f=i,g=Math.floor(h.data("height")/h.data("width")*i),g>j&&(g=j,f=Math.floor(h.data("width")/h.data("height")*j))):(g=j,f=Math.floor(h.data("width")/h.data("height")*j),f>i&&(f=i,g=Math.floor(h.data("height")/h.data("width")*i))),h.width(f).height(g)}$(".tweet_message_panel-text .tweet_message_panel_inner",$slide).fitTextBlock(),$("html").hasClass("flexbox")||$(".tweet_message_panel_inner",$slide).css("marginTop",($(".tweet_message_panel",$slide).outerHeight()-$(".tweet_message_panel_inner",$slide).height())/2.2)},b};